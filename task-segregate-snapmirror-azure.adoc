---
sidebar: sidebar 
permalink: task-segregate-snapmirror-azure.html 
keywords: segregate, SnapMirror, SnapMirror traffic, SnapMirror replication, add, additional NIC, new NIC, intercluster LIF, non-routable subnet, subnet 
summary: Com o Cloud Volumes ONTAP no Azure, você pode segregar o tráfego de replicação do SnapMirror usando uma rede diferente para melhorar a segurança e o desempenho dos dados. 
---
= Segregar o tráfego do SnapMirror no Azure
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
Com o Cloud Volumes ONTAP no Azure, você pode segregar o tráfego de replicação do SnapMirror do tráfego de dados e gerenciamento.  Para segregar o tráfego de replicação do SnapMirror do seu tráfego de dados, você adicionará uma nova placa de interface de rede (NIC), um LIF intercluster associado e uma sub-rede não roteável.



== Sobre a segregação de tráfego do SnapMirror no Azure

Por padrão, o NetApp Console configura todas as NICs e LIFs em uma implantação do Cloud Volumes ONTAP na mesma sub-rede.  Nessas configurações, o tráfego de replicação do SnapMirror e o tráfego de dados e gerenciamento usam a mesma sub-rede.  A segregação do tráfego do SnapMirror aproveita uma sub-rede adicional que não é roteável para a sub-rede existente usada para tráfego de dados e gerenciamento.

.Figura 1
Os diagramas a seguir mostram a segregação do tráfego de replicação do SnapMirror com uma NIC adicional, um LIF intercluster associado e uma sub-rede não roteável em uma única implantação de nó.  Uma implantação de par HA é um pouco diferente.

image:diagram-segregate-snapmirror-traffic.png["O diagrama ilustra a segregação do tráfego de replicação do SnapMirror em uma configuração de nó único"]

.Antes de começar
Revise as seguintes considerações:

* Você só pode adicionar uma única NIC a uma implantação de nó único ou par HA do Cloud Volumes ONTAP (instância de VM) para segregação de tráfego do SnapMirror .
* Para adicionar uma nova NIC, o tipo de instância de VM que você implanta deve ter uma NIC não utilizada.
* Os clusters de origem e destino devem ter acesso à mesma Rede Virtual (VNet).  O cluster de destino é um sistema Cloud Volumes ONTAP no Azure.  O cluster de origem pode ser um sistema Cloud Volumes ONTAP no Azure ou um sistema ONTAP .




== Etapa 1: crie uma NIC adicional e anexe-a à VM de destino

Esta seção fornece instruções sobre como criar uma NIC adicional e anexá-la à VM de destino.  A VM de destino é o nó único ou sistema de par HA no Cloud Volumes ONTAP no Azure onde você deseja configurar sua NIC adicional.

.Passos
. Na CLI do ONTAP , pare o nó.
+
[source, cli]
----
dest::> halt -node <dest_node-vm>
----
. No portal do Azure, verifique se o status da VM (nó) está parado.
+
[source, cli]
----
az vm get-instance-view --resource-group <dest-rg> --name <dest-vm> --query instanceView.statuses[1].displayStatus
----
. Use o ambiente Bash no Azure Cloud Shell para parar o nó.
+
.. Pare o nó.
+
[source, cli]
----
az vm stop --resource-group <dest_node-rg> --name <dest_node-vm>
----
.. Desaloque o nó.
+
[source, cli]
----
az vm deallocate --resource-group <dest_node-rg> --name <dest_node-vm>
----


. Configure regras de grupo de segurança de rede para tornar as duas sub-redes (sub-rede do cluster de origem e sub-rede do cluster de destino) não roteáveis entre si.
+
.. Crie a nova NIC na VM de destino.
.. Procure o ID da sub-rede do cluster de origem.
+
[source, cli]
----
az network vnet subnet show -g <src_vnet-rg> -n <src_subnet> --vnet-name <vnet> --query id
----
.. Crie a nova NIC na VM de destino com o ID de sub-rede da sub-rede do cluster de origem.  Aqui você insere o nome da nova NIC.
+
[source, cli]
----
az network nic create -g <dest_node-rg> -n <dest_node-vm-nic-new> --subnet <id_from_prev_command> --accelerated-networking true
----
.. Salve o endereço IP privado.  Este endereço IP, <new_added_nic_primary_addr>, é usado para criar um LIF intercluster em<<Step 2: Create a new IPspace,domínio de transmissão, LIF intercluster para o novo NIC>> .


. Anexe a nova NIC à VM.
+
[source, cli]
----
az vm nic add -g <dest_node-rg> --vm-name <dest_node-vm> --nics <dest_node-vm-nic-new>
----
. Inicie a VM (nó).
+
[source, cli]
----
az vm start --resource-group <dest_node-rg>  --name <dest_node-vm>
----
. No portal do Azure, acesse *Rede* e confirme se a nova NIC, por exemplo, nic-new, existe e se a rede acelerada está habilitada.
+
[source, cli]
----
az network nic list --resource-group azure-59806175-60147103-azure-rg --query "[].{NIC: name, VM: virtualMachine.id}"
----


Para implantações de par HA, repita as etapas para o nó parceiro.



== Etapa 2: criar um novo IPspace, domínio de transmissão e LIF intercluster para a nova NIC

Um IPspace separado para LIFs interclusters fornece separação lógica entre a funcionalidade de rede para replicação entre clusters.

Use o ONTAP CLI para as etapas a seguir.

.Passos
. Crie o novo IPspace (new_ipspace).
+
[source, cli]
----
dest::> network ipspace create -ipspace <new_ipspace>
----
. Crie um domínio de transmissão no novo IPspace (new_ipspace) e adicione a porta nic-new.
+
[source, cli]
----
dest::> network port show
----
. Para sistemas de nó único, a porta recém-adicionada é _e0b_.  Para implantações de par HA com discos gerenciados, a porta recém-adicionada é _e0d_.  Para implantações de pares HA com blobs de página, a porta recém-adicionada é _e0e_.  Use o nome do nó, não o nome da VM.  Encontre o nome do nó executando `node show` .
+
[source, cli]
----
dest::> broadcast-domain create -broadcast-domain <new_bd> -mtu 1500 -ipspace <new_ipspace> -ports <dest_node-cot-vm:e0b>
----
. Crie um LIF intercluster no novo domínio de transmissão (new_bd) e no novo NIC (nic-new).
+
[source, cli]
----
dest::> net int create -vserver <new_ipspace> -lif <new_dest_node-ic-lif> -service-policy default-intercluster -address <new_added_nic_primary_addr> -home-port <e0b> -home-node <node> -netmask <new_netmask_ip> -broadcast-domain <new_bd>
----
. Verifique a criação do novo LIF intercluster.
+
[source, cli]
----
dest::> net int show
----


Para implantações de par HA, repita as etapas para o nó parceiro.



== Etapa 3: verificar o peering do cluster entre os sistemas de origem e destino

Esta seção fornece instruções sobre como verificar o peering entre os sistemas de origem e destino.

Use o ONTAP CLI para as etapas a seguir.

.Passos
. Verifique se o LIF intercluster do cluster de destino pode executar ping no LIF intercluster do cluster de origem.  Como o cluster de destino executa esse comando, o endereço IP de destino é o endereço IP do LIF intercluster na origem.
+
[source, cli]
----
dest::> ping -lif <new_dest_node-ic-lif> -vserver <new_ipspace> -destination <10.161.189.6>
----
. Verifique se o LIF intercluster do cluster de origem pode executar ping no LIF intercluster do cluster de destino.  O destino é o endereço IP da nova NIC criada no destino.
+
[source, cli]
----
src::> ping -lif <src_node-ic-lif> -vserver <src_svm> -destination <10.161.189.18>
----


Para implantações de par HA, repita as etapas para o nó parceiro.



== Etapa 4: criar peering SVM entre os sistemas de origem e destino

Esta seção fornece instruções sobre como criar o peering SVM entre os sistemas de origem e de destino.

Use o ONTAP CLI para as etapas a seguir.

.Passos
. Crie o peering de cluster no destino usando o endereço IP do LIF intercluster de origem como `-peer-addrs` .  Para pares HA, liste o endereço IP do LIF intercluster de origem para ambos os nós como `-peer-addrs` .
+
[source, cli]
----
dest::> cluster peer create -peer-addrs <10.161.189.6> -ipspace <new_ipspace>
----
. Digite e confirme a senha.
. Crie um peering de cluster na origem usando o endereço IP do LIF do cluster de destino como `peer-addrs` .  Para pares HA, liste o endereço IP LIF do intercluster de destino para ambos os nós como `-peer-addrs` .
+
[source, cli]
----
src::> cluster peer create -peer-addrs <10.161.189.18>
----
. Digite e confirme a senha.
. Verifique se o cluster está pareado.
+
[source, cli]
----
src::> cluster peer show
----
+
O peering bem-sucedido mostra *Disponível* no campo de disponibilidade.

. Crie um peering SVM no destino.  Tanto os SVMs de origem quanto os de destino devem ser SVMs de dados.
+
[source, cli]
----
dest::> vserver peer create -vserver <dest_svm> -peer-vserver <src_svm> -peer-cluster <src_cluster> -applications snapmirror``
----
. Aceitar peering SVM.
+
[source, cli]
----
src::> vserver peer accept -vserver <src_svm> -peer-vserver <dest_svm>
----
. Verifique se o SVM está pareado.
+
[source, cli]
----
dest::> vserver peer show
----
+
Mostra de estado de pares*`peered` * e aplicações de peering mostram*`snapmirror` *.





== Etapa 5: Crie um relacionamento de replicação SnapMirror entre o sistema de origem e o de destino

Esta seção fornece instruções sobre como criar um relacionamento de replicação do SnapMirror entre o sistema de origem e o de destino.

Para mover um relacionamento de replicação SnapMirror existente, você deve primeiro quebrar o relacionamento de replicação SnapMirror existente antes de criar um novo relacionamento de replicação SnapMirror .

Use o ONTAP CLI para as etapas a seguir.

.Passos
. Crie um volume de dados protegido no SVM de destino.
+
[source, cli]
----
dest::> vol create -volume <new_dest_vol> -vserver <dest_svm> -type DP -size <10GB> -aggregate <aggr1>
----
. Crie o relacionamento de replicação do SnapMirror no destino, que inclui a política do SnapMirror e o agendamento para a replicação.
+
[source, cli]
----
dest::> snapmirror create -source-path src_svm:src_vol  -destination-path  dest_svm:new_dest_vol -vserver dest_svm -policy MirrorAllSnapshots -schedule 5min
----
. Inicialize o relacionamento de replicação do SnapMirror no destino.
+
[source, cli]
----
dest::> snapmirror initialize -destination-path  <dest_svm:new_dest_vol>
----
. Na CLI do ONTAP , valide o status do relacionamento do SnapMirror executando o seguinte comando:
+
[source, cli]
----
dest::> snapmirror show
----
+
O status do relacionamento é `Snapmirrored` e a saúde do relacionamento é `true` .

. Opcional: Na CLI do ONTAP , execute o seguinte comando para visualizar o histórico de ações do relacionamento SnapMirror .
+
[source, cli]
----
dest::> snapmirror show-history
----


Opcionalmente, você pode montar os volumes de origem e destino, gravar um arquivo na origem e verificar se o volume está sendo replicado para o destino.
